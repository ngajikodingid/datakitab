<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin Terjemah Kitab — Firestore (Final, Auto Update)</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b0f19; --card:#0f1526; --line:#1d2742; --txt:#e6ecff; --muted:#aab7d4; --accent:#59a6ff;
    --ok:#22c55e; --err:#ef4444; --warn:#f59e0b;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f6f8fb; --card:#ffffff; --line:#e5e7eb; --txt:#0b1220; --muted:#64748b; --accent:#2563eb; }
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  a{color:var(--accent)}
  .container{max-width:1200px;margin:0 auto;padding:72px 16px 80px}
  header.topbar{
    position:sticky;top:0;z-index:50;background:var(--bg);border-bottom:1px solid var(--line);
    display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 16px;
  }
  .brand{font-weight:800}
  .sub{color:var(--muted);font-size:12px}
  .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px}
  .btn{
    border:1px solid var(--line);background:var(--card);color:var(--txt);
    border-radius:10px;padding:8px 12px;cursor:pointer;display:inline-flex;gap:8px;align-items:center
  }
  .btn:hover{background:color-mix(in srgb, var(--card) 85%, #ffffff 15%)}
  .btn.pri{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn.warn{border-color:color-mix(in srgb,var(--err) 50%, var(--line) 50%);color:var(--err)}
  .btn.ghost{background:transparent}
  .grid{display:grid;gap:16px;grid-template-columns:1fr}
  @media(min-width:980px){.grid{grid-template-columns:320px 1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .card h2{margin:0;padding:12px 14px;border-bottom:1px solid var(--line);font-size:15px}
  .card .body{padding:14px}
  .row{display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;margin-bottom:10px}
  .row label{color:var(--muted)}
  input[type=text],input[type=number],textarea,select{
    width:100%;border:1px solid var(--line);background:transparent;color:var(--txt);
    border-radius:10px;padding:9px 12px
  }
  textarea{min-height:84px;resize:vertical}
  .muted{color:var(--muted);font-size:12px}
  #search{max-width:360px}

  /* pages */
  .pages{display:grid;gap:12px}
  details.page{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:color-mix(in srgb,var(--card) 92%, #000 8%)}
  details.page summary{
    list-style:none;padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer;
    display:grid;grid-template-columns:64px 1fr 240px auto;gap:8px;align-items:center
  }
  details.page[open] summary{border-bottom-color:transparent}
  .idx{width:60px}
  .aid{width:240px}
  .summary-col{display:flex;gap:8px;align-items:center}
  .summary-title{overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
  .summary-actions{display:flex;gap:6px}
  .page .body{padding:12px;border-top:1px solid var(--line)}
  .mini{font-size:12px;color:var(--muted)}
  .rtl{direction:rtl;text-align:right;font-family:"Amiri",serif}

  /* toast & loader */
  .toast{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:60}
  .toast .item{background:var(--card);border:1px solid var(--line);padding:10px 12px;border-radius:10px;min-width:240px}
  .item.ok{border-color:color-mix(in srgb,var(--ok) 40%, var(--line) 60%)}
  .item.err{border-color:color-mix(in srgb,var(--err) 40%, var(--line) 60%)}
  .spinner{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);z-index:70;align-items:center;justify-content:center}
  .spinner .dot{width:12px;height:12px;border-radius:999px;background:#fff;opacity:.9;margin:6px;animation:bl 1s infinite alternate}
  .spinner .dot:nth-child(2){animation-delay:.2s}.spinner .dot:nth-child(3){animation-delay:.4s}
  @keyframes bl{from{transform:scale(.8);opacity:.5}to{transform:scale(1.3);opacity:1}}
</style>
</head>
<body>
<header class="topbar">
  <div>
    <div class="brand">Admin Terjemah Kitab</div>
    <div class="sub">Firestore editor • Auto Update</div>
  </div>
  <div class="bar">
    <div id="userBox" class="chip">Belum login</div>
    <button id="btnLogin" class="btn">Login Google</button>
    <button id="btnLogout" class="btn warn">Logout</button>
  </div>
</header>

<div class="container">
  <div class="grid">
    <!-- SIDEBAR -->
    <section class="card">
      <h2>Proyek & Kitab</h2>
      <div class="body">
        <div class="row"><label>Slug</label><input id="slug" type="text" placeholder="ajrumiyyah"></div>
        <div class="row"><label>Actions</label>
          <div class="bar">
            <button id="btnLoadAll" class="btn pri">Muat</button>
            <button id="btnReindex" class="btn">Reindex</button>
            <button id="btnSaveAll" class="btn">Simpan Semua</button>
          </div>
        </div>
        <p class="muted">Path: <code>kitab/&lt;slug&gt;</code> + subkoleksi <code>pages</code>.</p>
        <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">
        <div class="row"><label>Cari</label><input id="search" type="text" placeholder="Ketik judul / id…"></div>
        <div class="bar">
          <button id="btnExpand" class="btn">Expand All</button>
          <button id="btnCollapse" class="btn">Collapse All</button>
          <button id="btnAddPage" class="btn">+ Tambah Halaman</button>
        </div>
      </div>
    </section>

    <!-- MAIN -->
    <section class="card">
      <h2>Metadata Kitab</h2>
      <div class="body">
        <div class="row"><label>Judul</label><input id="judul" type="text"></div>
        <div class="row"><label>Penulis</label><input id="penulis" type="text"></div>
        <div class="row"><label>Penerjemah</label><input id="penerjemah" type="text"></div>
        <div class="row"><label>Penerbit</label><input id="penerbit" type="text"></div>
        <div class="row"><label>Halaman</label><input id="halaman" type="number" min="0" placeholder="auto dari pages"></div>
        <div class="bar" style="justify-content:flex-end">
          <button id="btnSaveMeta" class="btn pri">Simpan Metadata</button>
          <button id="btnReloadMeta" class="btn">Muat Ulang</button>
        </div>
      </div>
    </section>
  </div>

  <section class="card" style="margin-top:16px">
    <h2>Halaman (Pages)</h2>
    <div class="body">
      <div class="muted" style="margin-bottom:8px">Ketik pada judul/teks untuk autosave (±0.8s). Atau pakai tombol **Simpan**.</div>
      <div id="pages" class="pages"></div>
    </div>
  </section>
</div>

<!-- Toasts & Loader -->
<div class="toast" id="toast"></div>
<div class="spinner" id="spinner"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

<!-- Firebase v10 -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import {
    initializeFirestore, persistentLocalCache, persistentMultipleTabManager,
    doc, getDoc, setDoc, updateDoc, deleteDoc,
    collection, getDocs, addDoc, writeBatch, query, orderBy
  } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  /* === CONFIG (ganti bila perlu) === */
  const firebaseConfig = {
    apiKey: "AIzaSyCco9E-DrkMGaoCXnZsP6a7IA1GwSgvU8k",
    authDomain: "terjemah-kitab-84103.firebaseapp.com",
    projectId: "terjemah-kitab-84103",
    storageBucket: "terjemah-kitab-84103.firebasestorage.app",
    messagingSenderId: "677836780803",
    appId: "1:677836780803:web:27cff770af01a4d900a536",
    measurementId: "G-FRWV8S6X8N"
  };

  /* === INIT (stabil untuk Blogger/ISP): long-poll + no fetch streams) === */
  const app = initializeApp(firebaseConfig);
  const db  = initializeFirestore(app, {
    experimentalAutoDetectLongPolling: true,
    useFetchStreams: false,
    localCache: persistentLocalCache({ tabManager: persistentMultipleTabManager() })
  });
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  /* === DOM helpers === */
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const toastEl = $("#toast");
  const spinEl  = $("#spinner");
  const pagesEl = $("#pages");

  const showSpin = (v=true)=> spinEl.style.display = v ? "flex" : "none";
  function toast(msg, type=""){ const d=document.createElement("div"); d.className=`item ${type}`; d.textContent=msg; toastEl.appendChild(d); setTimeout(()=>d.remove(), 2400); }

  /* === Auth === */
  onAuthStateChanged(auth, (user)=>{
    if(user){ $("#userBox").textContent = user.email; $("#userBox").classList.add("chip"); toast("Login: "+user.email,"ok"); }
    else { $("#userBox").textContent = "Belum login"; }
  });
  $("#btnLogin").onclick  = ()=> signInWithPopup(auth, provider).catch(e=> toast("Login gagal: "+e.message,"err"));
  $("#btnLogout").onclick = ()=> signOut(auth).then(()=> toast("Logout","ok")).catch(e=> toast("Logout gagal: "+e.message,"err"));

  /* === Utils === */
  const slugify = (s="") =>
    (s.normalize("NFD").replace(/[\u0300-\u036f]/g,"")
       .replace(/[^A-Za-z0-9\u0621-\u064A]+/g,"-")
       .replace(/^-+|-+$/g,"").toLowerCase()) || ("hal-"+Date.now());

  async function updatePageCount(slug){
    const snap = await getDocs(collection(db,"kitab",slug,"pages"));
    await setDoc(doc(db,"kitab",slug), { halaman: snap.size }, { merge:true });
  }

  /* === Metadata === */
  async function loadMeta(slug){
    const s = await getDoc(doc(db,"kitab",slug));
    if(!s.exists()){ toast("Metadata belum ada","err"); return; }
    const d = s.data();
    $("#judul").value      = d.judul||"";
    $("#penulis").value    = d.penulis||"";
    $("#penerjemah").value = d.penerjemah||"";
    $("#penerbit").value   = d.penerbit||"";
    $("#halaman").value    = d.halaman||0;
  }
  async function saveMeta(){
    const slug = ($("#slug").value||"").trim().toLowerCase();
    if(!slug) return toast("Isi slug dulu","err");
    showSpin(true);
    try{
      await setDoc(doc(db,"kitab",slug), {
        judul: $("#judul").value.trim(),
        penulis: $("#penulis").value.trim(),
        penerjemah: $("#penerjemah").value.trim(),
        penerbit: $("#penerbit").value.trim(),
        ...(Number($("#halaman").value)? {halaman:Number($("#halaman").value)} : {})
      }, { merge:true });
      toast("Metadata disimpan","ok");
    }catch(e){ toast("Gagal simpan metadata: "+e.message,"err"); }
    showSpin(false);
  }

  /* === Debounce helper (autosave) === */
  const timers = new Map();
  function debounce(key, fn, wait=800){
    clearTimeout(timers.get(key));
    const t = setTimeout(fn, wait);
    timers.set(key, t);
  }

  /* === Page Card (string-based) === */
  function renderPageCard({docId="", index=1, judul="", id="", arabicText="", translationText=""}){
    const wrap = document.createElement("details");
    wrap.className = "page";
    wrap.open = false;

    const summary = document.createElement("summary");
    summary.innerHTML = `
      <input class="idx" type="number" min="1" value="${index}">
      <div class="summary-col">
        <span class="muted">Judul</span>
        <span class="summary-title">${judul || "(tanpa judul)"}&nbsp;</span>
      </div>
      <input class="aid" type="text" value="${id||""}" placeholder="id (anchor)">
      <div class="summary-actions">
        <button class="btn" data-act="up"   title="Naik">↑</button>
        <button class="btn" data-act="down" title="Turun">↓</button>
        <button class="btn pri" data-act="save" title="Simpan">Simpan</button>
        <button class="btn warn" data-act="del"  title="Hapus">Hapus</button>
      </div>
    `;
    wrap.appendChild(summary);

    const body = document.createElement("div");
    body.className = "body";
    body.innerHTML = `
      <div class="row">
        <label>Judul</label>
        <input class="title" type="text" value="${judul||""}" placeholder="Judul halaman (boleh Arab)">
      </div>
      <div class="row">
        <label>Arab</label>
        <textarea class="arabText rtl" placeholder="Baris dipisah Enter…">${arabicText||""}</textarea>
      </div>
      <div class="row">
        <label>Terjemah</label>
        <textarea class="indoText" placeholder="Baris dipisah Enter…">${translationText||""}</textarea>
      </div>
      <div class="bar" style="justify-content:flex-end">
        <button class="btn" data-act="genid">Buat ID dari Judul</button>
      </div>
    `;
    wrap.appendChild(body);

    // dataset
    wrap.dataset.docId = docId;

    // actions
    wrap.addEventListener("click", async (e)=>{
      const act = e.target?.dataset?.act; if(!act) return;
      if(act==="genid")  wrap.querySelector(".aid").value = slugify(wrap.querySelector(".title").value||"");
      if(act==="up")     moveCard(wrap,-1);
      if(act==="down")   moveCard(wrap,  1);
      if(act==="del")    await deleteCard(wrap);
      if(act==="save")   await saveCard(wrap);
    });

    // live preview title
    body.querySelector(".title").addEventListener("input", (ev)=>{
      wrap.querySelector(".summary-title").textContent = ev.target.value || "(tanpa judul)";
      autoSaveCard(wrap);
    });
    // autosave index/id/teks
    summary.querySelector(".idx").addEventListener("input", ()=> autoSaveCard(wrap));
    summary.querySelector(".aid").addEventListener("input", ()=> autoSaveCard(wrap));
    body.querySelector(".arabText").addEventListener("input", ()=> autoSaveCard(wrap));
    body.querySelector(".indoText").addEventListener("input", ()=> autoSaveCard(wrap));

    return wrap;
  }

  function moveCard(card, dir){
    const parent = card.parentElement;
    if(dir<0 && card.previousElementSibling) parent.insertBefore(card, card.previousElementSibling);
    if(dir>0 && card.nextElementSibling)     parent.insertBefore(card.nextElementSibling, card);
    [...parent.children].forEach((c,i)=> c.querySelector(".idx").value = i+1);
    autoSaveCard(card); // simpan index baru
  }

  function readCard(card){
    const index = Number(card.querySelector(".idx").value)||1;
    const judul = card.querySelector(".title").value.trim();
    const id    = (card.querySelector(".aid").value.trim() || slugify(judul));
    const arabicText      = (card.querySelector(".arabText").value || "").trim();
    const translationText = (card.querySelector(".indoText").value || "").trim();
    return { index, judul, id, arabicText, translationText, docId: card.dataset.docId||"" };
  }

  async function saveCard(card){
    const slug = ($("#slug").value||"").trim().toLowerCase();
    if(!slug) return toast("Isi slug dulu","err");
    const data = readCard(card);
    try{
      if(!data.docId){
        const ref = await addDoc(collection(db,"kitab",slug,"pages"), data);
        card.dataset.docId = ref.id;
      }else{
        await updateDoc(doc(db,"kitab",slug,"pages",data.docId), data);
      }
      await updatePageCount(slug);
      toast("Tersimpan","ok");
    }catch(e){ toast("Gagal simpan: "+e.message,"err"); }
  }

  function autoSaveCard(card){
    const slug = ($("#slug").value||"").trim().toLowerCase();
    if(!slug) return;
    debounce(`page-${card.dataset.docId || Math.random()}`, ()=> saveCard(card), 800);
  }

  async function deleteCard(card){
    const slug = ($("#slug").value||"").trim().toLowerCase();
    if(!slug) return toast("Isi slug dulu","err");
    if(!confirm("Hapus halaman ini?")) return;
    try{
      const id = card.dataset.docId;
      if(id) await deleteDoc(doc(db,"kitab",slug,"pages",id));
      card.remove();
      await updatePageCount(slug);
      toast("Halaman dihapus","ok");
    }catch(e){ toast("Gagal hapus: "+e.message,"err"); }
  }

  /* === Batch ops === */
  async function saveAll(){
    const slug = ($("#slug").value||"").trim().toLowerCase();
    if(!slug) return toast("Isi slug dulu","err");
    const cards = $$("#pages .page");
    showSpin(true);
    try{
      const batch = writeBatch(db);
      // update yang sudah punya docId
      for(const card of cards){
        const d = readCard(card);
        if(d.docId){
          batch.update(doc(db,"kitab",slug,"pages",d.docId), d);
        }
      }
      await batch.commit();
      // tambah yang belum punya docId
      for(const card of cards){
        const d = readCard(card);
        if(!d.docId){
          const ref = await addDoc(collection(db,"kitab",slug,"pages"), d);
          card.dataset.docId = ref.id;
        }
      }
      await updatePageCount(slug);
      toast("Simpan semua selesai","ok");
    }catch(e){ toast("Gagal simpan semua: "+e.message,"err"); }
    showSpin(false);
  }

  async function reindexAll(){
    const slug = ($("#slug").value||"").trim().toLowerCase();
    if(!slug) return toast("Isi slug dulu","err");
    const cards = $$("#pages .page");
    showSpin(true);
    try{
      cards.forEach((c,i)=> c.querySelector(".idx").value = i+1);
      const batch = writeBatch(db);
      for(const card of cards){
        const id = card.dataset.docId;
        if(id){
          const idx = Number(card.querySelector(".idx").value)||1;
          batch.update(doc(db,"kitab",slug,"pages",id), { index: idx });
        }
      }
      await batch.commit();
      await updatePageCount(slug);
      toast("Reindex selesai","ok");
    }catch(e){ toast("Gagal reindex: "+e.message,"err"); }
    showSpin(false);
  }

  /* === Load all === */
  async function loadAll(){
    const slug = ($("#slug").value||"").trim().toLowerCase();
    if(!slug) return toast("Isi slug dulu","err");
    showSpin(true);
    try{
      await loadMeta(slug);
      pagesEl.innerHTML = "";
      const snap = await getDocs(query(collection(db,"kitab",slug,"pages"), orderBy("index","asc")));
      if(snap.empty){ pagesEl.innerHTML = `<div class="muted">Belum ada halaman.</div>`; showSpin(false); return; }
      snap.forEach(d=>{
        const x = d.data();
        // kompatibel data lama (array) → join
        const aText = typeof x.arabicText === "string"
          ? x.arabicText
          : Array.isArray(x.arabic) ? x.arabic.join("\n") : (x.arabic||"");
        const tText = typeof x.translationText === "string"
          ? x.translationText
          : Array.isArray(x.translation) ? x.translation.join("\n") : (x.translation||"");
        const card = renderPageCard({
          docId:d.id, index:x.index, judul:x.judul, id:x.id,
          arabicText:aText, translationText:tText
        });
        pagesEl.appendChild(card);
      });
      toast(`Memuat ${snap.size} halaman`,"ok");
    }catch(e){ toast("Gagal memuat: "+e.message,"err"); }
    showSpin(false);
  }

  /* === Search / Filter === */
  $("#search").addEventListener("input", (e)=>{
    const q = e.target.value.trim().toLowerCase();
    $$("#pages .page").forEach(card=>{
      const title = card.querySelector(".summary-title")?.textContent.toLowerCase() || "";
      const aid   = card.querySelector(".aid")?.value.toLowerCase() || "";
      card.style.display = (title.includes(q) || aid.includes(q)) ? "" : "none";
    });
  });

  /* === UI events === */
  $("#btnSaveMeta").onclick    = ()=> saveMeta();
  $("#btnReloadMeta").onclick  = ()=> { const s=($("#slug").value||"").trim().toLowerCase(); if(!s) return toast("Isi slug dulu","err"); loadMeta(s).catch(e=>toast(e.message,"err")); };
  $("#btnLoadAll").onclick     = ()=> loadAll();
  $("#btnReindex").onclick     = ()=> reindexAll();
  $("#btnSaveAll").onclick     = ()=> saveAll();

  function addNewCard(){
    const maxIdx = $$("#pages .page").length + 1;
    const c = renderPageCard({index:maxIdx, judul:"", id:"", arabicText:"", translationText:""});
    pagesEl.appendChild(c);
    c.open = true;
    c.scrollIntoView({behavior:"smooth", block:"start"});
  }
  $("#btnAddPage").onclick = addNewCard;

  $("#btnExpand").onclick  = ()=> $$("#pages .page").forEach(c=> c.open = true);
  $("#btnCollapse").onclick= ()=> $$("#pages .page").forEach(c=> c.open = false);
</script>
</body>
</html>
